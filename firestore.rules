rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function myUid() {
      return request.auth.uid;
    }

    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(myUid()));
    }

    function myRole() {
      return isSignedIn() ? myUserDoc().data.role : null;
    }

    function isAdmin() {
      return myRole() == "admin";
    }

    function isModerator() {
      return myRole() == "moderator";
    }

    function isStaff() {
      return isAdmin() || isModerator();
    }

    function validRole(role) {
      return role in ["admin", "moderator", "member"];
    }

    function validPostType(t) {
      return t in ["pune", "shtepi", "juridike", "edukim", "bamiresi", "media"];
    }

    function validStatus(s) {
      return s in ["pending", "approved", "rejected"];
    }

    match /users/{uid} {
      allow create: if isSignedIn() && uid == myUid()
        && request.resource.data.role == "member"
        && request.resource.data.email == request.auth.token.email;

      allow read: if isSignedIn() && (uid == myUid() || isStaff());

      allow update: if isSignedIn() && (
        (uid == myUid()
          && request.resource.data.role == resource.data.role
          && request.resource.data.email == resource.data.email)
        || (isAdmin() && validRole(request.resource.data.role))
      );

      allow delete: if false;
    }

    match /posts/{postId} {
      allow read: if resource.data.status == "approved"
        || (isSignedIn() && (isStaff() || resource.data.authorId == myUid()));

      allow create: if isSignedIn()
        && validPostType(request.resource.data.type)
        && request.resource.data.authorId == myUid()
        && request.resource.data.status == "pending"
        && request.resource.data.title is string
        && request.resource.data.title.size() >= 3
        && request.resource.data.content is string
        && request.resource.data.content.size() >= 10;

      allow update: if isSignedIn() && (
        (resource.data.authorId == myUid()
          && resource.data.status == "pending"
          && request.resource.data.status == "pending"
          && request.resource.data.authorId == myUid()
          && request.resource.data.type == resource.data.type)
        || (isStaff()
          && request.resource.data.authorId == resource.data.authorId
          && request.resource.data.type == resource.data.type
          && validStatus(request.resource.data.status))
      );

      allow delete: if isSignedIn() && (isStaff() || (resource.data.authorId == myUid() && resource.data.status == "pending"));
    }

    match /posts/{postId}/comments/{commentId} {
      allow read: if get(/databases/$(database)/documents/posts/$(postId)).data.status == "approved"
        || (isSignedIn() && (isStaff() || get(/databases/$(database)/documents/posts/$(postId)).data.authorId == myUid()));

      allow create: if isSignedIn()
        && request.resource.data.authorId == myUid()
        && request.resource.data.text is string
        && request.resource.data.text.size() >= 1
        && request.resource.data.text.size() <= 2000;

      allow update, delete: if isSignedIn()
        && resource.data.authorId == myUid();
    }

    match /reports/{reportId} {
      allow create: if isSignedIn()
        && request.resource.data.reporterId == myUid()
        && request.resource.data.targetType in ["post", "comment"]
        && request.resource.data.reason is string
        && request.resource.data.reason.size() >= 3;

      allow read: if isSignedIn() && isStaff();
      allow update, delete: if isSignedIn() && isStaff();
    }
  }
}